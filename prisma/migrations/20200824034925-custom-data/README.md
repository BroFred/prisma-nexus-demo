# Migration `20200824034925-custom-data`

This migration has been generated by Xingyi Chen at 8/24/2020, 11:49:25 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE `db`.`CustomData` (
`id` varchar(191)  NOT NULL ,
`workflowId` varchar(191)  NOT NULL ,
`type` ENUM('select', 'multiSelect', 'text')  NOT NULL ,
`dataSourceId` varchar(191)  NOT NULL ,
`data` json  NOT NULL ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `db`.`CustomDataDataSource` (
`id` varchar(191)  NOT NULL ,
`type` varchar(191)  NOT NULL ,
`meta` json  NOT NULL ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `db`.`Field` (
`id` varchar(191)  NOT NULL ,
`type` varchar(191)  NOT NULL ,
`customDataDataSourceId` varchar(191)  NOT NULL ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `db`.`WorkflowTemplate` (
`id` varchar(191)  NOT NULL ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `db`.`_UserToWorkflow` (
`A` varchar(191)  NOT NULL ,
`B` varchar(191)  NOT NULL ,
UNIQUE Index `_UserToWorkflow_AB_unique`(`A`,
`B`),
Index `_UserToWorkflow_B_index`(`B`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `db`.`_FieldToWorkflowTemplate` (
`A` varchar(191)  NOT NULL ,
`B` varchar(191)  NOT NULL ,
UNIQUE Index `_FieldToWorkflowTemplate_AB_unique`(`A`,
`B`),
Index `_FieldToWorkflowTemplate_B_index`(`B`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

ALTER TABLE `db`.`CustomData` ADD FOREIGN KEY (`workflowId`) REFERENCES `db`.`Workflow`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `db`.`CustomData` ADD FOREIGN KEY (`dataSourceId`) REFERENCES `db`.`CustomDataDataSource`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `db`.`Field` ADD FOREIGN KEY (`customDataDataSourceId`) REFERENCES `db`.`CustomDataDataSource`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `db`.`_UserToWorkflow` ADD FOREIGN KEY (`A`) REFERENCES `db`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `db`.`_UserToWorkflow` ADD FOREIGN KEY (`B`) REFERENCES `db`.`Workflow`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `db`.`_FieldToWorkflowTemplate` ADD FOREIGN KEY (`A`) REFERENCES `db`.`Field`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `db`.`_FieldToWorkflowTemplate` ADD FOREIGN KEY (`B`) REFERENCES `db`.`WorkflowTemplate`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200820021546-inini..20200824034925-custom-data
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "mysql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -19,8 +19,13 @@
 enum WorkflowType {
   sequencial
   parallel
 }
+enum CustomDataType {
+  select
+  multiSelect
+  text
+}
 model User {
   id    String  @id @default(uuid())
   email String?
@@ -28,8 +33,9 @@
   name  String?
   createdByMe Workflow[]  @relation("createdByMe")
   assignedToMe Workflow[] @relation("assignedToMe")
   reportedToMe Workflow[] @relation("reportedToMe")
+  watchedByMe Workflow[] @relation(references: [id])
 }
 model Workflow {
   name  String?
@@ -47,5 +53,41 @@
   previous  Workflow? @relation("neighbor",fields: [previousId], references: [id])
   next  Workflow? @relation("neighbor")
   parent  Workflow? @relation("parentChild", fields: [parentId], references: [id])
   children  Workflow[] @relation("parentChild")
-}
+  customDatas CustomData[] @relation("customData")
+  watcher User[] @relation(references: [id])
+}
+
+model CustomData {
+  id  String @id @default(uuid())
+  workflowId  String 
+  workflow  Workflow @relation("customData", fields: [workflowId], references: [id])
+  type CustomDataType
+  dataSourceId String 
+  dataSource CustomDataDataSource @relation("dataSource", fields: [dataSourceId], references: [id])
+  data Json
+}
+
+// modular custom datasource builder
+model CustomDataDataSource {
+  id  String @id @default(uuid())
+  type String
+  meta Json
+}
+
+// modular templating
+model Field {
+  id  String @id @default(uuid())
+  type String
+  dataSource CustomDataDataSource
+  WorkflowTemplates WorkflowTemplate[] @relation(references: [id])
+}
+
+model WorkflowTemplate {
+  id  String @id @default(uuid())
+  fields Field[] @relation(references: [id])
+}
+
+//https://github.com/flitbit/diff modular data diff log
+//https://github.com/maticzav/graphql-shield modular auth
+//
```


